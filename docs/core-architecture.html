<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Marathon: New Core Architecture</title>
    <link rel="icon" type="image/x-icon" href="/marathon/img/marathon-favicon.ico">
    <link href="//cdn.jsdelivr.net/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="/marathon/css/style.css" rel="stylesheet">
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-45222428-4', 'auto');
      ga('send', 'pageview');
    </script>
  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="col-sm-10 col-sm-offset-1">
          <div class="navbar navbar-default navbar-inverse" role="navigation">
            <div class="container-fluid">
              <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
                  <span class="sr-only">Toggle navigation</span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/marathon/">Marathon</a>
              </div>
              <div class="collapse navbar-collapse" id="navbar-collapse">
                <ul class="nav navbar-nav">
                  <li class="active">
                    <a href="/marathon/docs/">Docs</a>
                  </li>
                  <li >
                    <a href="/marathon/resources.html">Resources</a>
                  </li>
                  <li >
                    <a href="/marathon/support.html">Support</a>
                  </li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                  <li><a href="https://github.com/mesosphere/marathon">GitHub</a></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="row">
    <div class="col-sm-3">

        <h5>Getting Started</h5>
        <ul class="list-unstyled">
            <li>
                <a href="/marathon/docs/">
                    Install Marathon
                </a>
            </li>
            <li>
                <a href="/marathon/docs/setup.html">
                    Setup Recommendations
                </a>
            </li>
            <li>
                <a href="/marathon/docs/high-availability.html">
                    High Availability Mode
                </a>
            </li>
        </ul>

        <h5>Using Marathon</h5>
        <ul class="list-unstyled">
            <li>
                <a href="/marathon/docs/application-basics.html">
                    Application Basics
                </a>
            </li>
            <li>
                <a href="/marathon/docs/deployments.html">
                    Application Deployments
                </a>
            </li>
            <li>
                <a href="/marathon/docs/application-groups.html">
                    Application Groups
                </a>
            </li>
            <li>
                <a href="/marathon/docs/artifact-store.html">
                    Artifact Store
                </a>
            </li>
            <li>
                <a href="/marathon/docs/auth-access-ctrl.html">
                    Authorization and Access Control
                </a>
            </li>
            <li>
                <a href="/marathon/docs/blue-green-deploy.html">
                    Blue-Green Deployment
                </a>
            </li>
            <li>
                <a href="/marathon/docs/constraints.html">
                    Constraints
                </a>
            </li>
            <li>
                <a href="/marathon/docs/event-bus.html">
                    Event Bus
                </a>
            </li>
            <li>
                <a href="/marathon/docs/health-checks.html">
                    Health Checks
                </a>
            </li>
            <li>
                <a href="/marathon/docs/ip-per-task.html">
                    IP-per-task
                </a>
            </li>
            <li>
                <a href="/marathon/docs/marathon-ui.html">
                    Marathon Web Interface
                </a>
            </li>
            <li>
                <a href="/marathon/docs/ports.html">
                    Ports
                </a>
            </li>
            <li>
                <a href="/marathon/docs/recipes.html">
                    Recipes
                </a>
            </li>
            <li>
                <a href="/marathon/docs/native-docker.html">
                    Running Docker Containers
                </a>
            </li>
            <li>
                <a href="/marathon/docs/persistent-volumes.html">
                    Stateful Applications Using Local Persistent Volumes
                </a>
            </li>
            <li>
                <a href="/marathon/docs/external-volumes.html">
                    Stateful Applications Using External Persistent Volumes
                </a>
            </li>
            <li>
                <a href="/marathon/docs/task-environment-vars.html">
                    Task Environment Variables
                </a>
            </li>
        </ul>

        <h5>Administration</h5>
        <ul class="list-unstyled">
            <li>
                <a href="/marathon/docs/command-line-flags.html">
                    Command Line Flags
                </a>
            </li>
            <li>
                <a href="/marathon/docs/framework-authentication.html">
                    Framework Authentication
                </a>
            </li>
            <li>
                <a href="/marathon/docs/high-availability.html">
                    High Availability
                </a>
            </li>
            <li>
                <a href="/marathon/docs/metrics.html">
                    Metrics
                </a>
            </li>
            <li>
                <a href="/marathon/docs/readiness-checks.html">
                    Readiness Checks
                </a>
            </li>
            <li>
                <a href="/marathon/docs/service-discovery-load-balancing.html">
                    Service Discovery and Load Balancing
                </a>
            </li>
            <li>
                <a href="/marathon/docs/ssl-basic-access-authentication.html">
                    SSL and Basic Authentication
                </a>
            </li>
            <li>
                <a href="/marathon/docs/upgrade/index.html">
                    Upgrading
                </a>
            </li>
            <li>
                <a href="/marathon/docs/upgrade/06xto070.html">
                    Upgrading from 0.6.x
                </a>
            </li>
            <li>
                <a href="/marathon/docs/native-docker-private-registry.html">
                    Using a Private Docker Registry
                </a>
            </li>
            <li>
                <a href="/marathon/docs/upgrade/versioning.html">
                    Versioning
                </a>
            </li>
        </ul>

        <h5>Troubleshooting</h5>
        <ul class="list-unstyled">
            <li>
                <a href="/marathon/docs/waiting.html">
                    An App Does Not Leave "Waiting"
                </a>
            </li>
            <li>
                <a href="/marathon/docs/host-port.html">
                    An App Requires a Specific Host Port
                </a>
            </li>
            <li>
                <a href="/marathon/docs/local-cert.html">
                    Error Using HTTPS with local CA Certificate
                </a>
            </li>
            <li>
                <a href="/marathon/docs/auth-secret.html">
                    Error Reading Authentication Secret
                </a>
            </li>
        </ul>

        <h5>Development</h5>
        <ul class="list-unstyled">
            <li>
                <a href="/marathon/docs/contributing.html">
                    Contributor Guidelines
                </a>
            </li>
            <li>
                <a href="/marathon/docs/core-architecture.html">
                    Current Marathon Development
                </a>
            </li>
            <li>
                <a href="/marathon/docs/plugin.html">
                    Extend Marathon with Plugins
                </a>
            </li>
            <li>
                <a href="/marathon/docs/developing-vm.html">
                    Run a Local Version of Marathon
                </a>
            </li>
        </ul>

        <h5>API Reference</h5>
        <ul class="list-unstyled">
        <li>
            <a href="/marathon/docs/generated/api.html">REST API Reference</a>
        </li>

        <li><a href="/marathon/docs/rest-api.html">REST API Reference (deprecated)</a></li>

        </ul>
    </div>

    <div class="col-sm-9">
        <h1 id="new-core-architecture">New Core Architecture</h1>

<p>We want to move Marathon to a new architecture iteratively. Components that already have been
 migrated live in the <code>mesosphere.marathon.core</code> package.</p>

<p>The goals are:</p>

<ul>
<li>Use a consistent strategy in dealing with shared mutable state

<ul>
<li>Use Actors but only as an implementation detail (see below)</li>
<li>Propogate creates/updates to durable storage but serve reads from memory</li>
</ul></li>
<li>Make the architecture of Marathon easier to understand and make it easier to replace sub modules.

<ul>
<li>Better separation of concerns</li>
<li>Less coupling</li>
</ul></li>
</ul>

<h1 id="first-step-launchqueue">First Step: LaunchQueue</h1>

<p>As a first step, we reimplement offer matching and task launching by providing
a new implementation for the <code>LaunchQueue</code> (formerly <code>TaskQueue</code>) and the <code>IterativeOfferMatcher</code>. That means
that some glue code is necessary for a while but it allows us to progress
iteratively.</p>

<p class="text-center">
  <img
    src="/marathon/img/core-architecture.png"
    width="704" height="518"
    alt="Core Architecture">
</p>

<p>The <code>LaunchQueue</code> manages starting of new tasks. Other parts of Marathon can request launching tasks for a specific
application by calling the <code>add</code> method of the <code>LaunchQueue</code>. For every application, the underlying
<code>LaunchQueueActor</code> creates an <code>AppTaskLauncherActor</code>. These <code>AppTaskLauncherActor</code> subscribe for
resource offers and may match tasks to launch for the received offers. The <code>OfferMatcherManager</code>
distributes the incoming offers along all interested subscribers. When an offer has been completely processed, the
<code>OfferProcessor</code> forwards the result to the <code>Launcher</code> such that the appropriate tasks are launched or the offer
gets rejected. Updates of task state are propagated via the <code>TaskStatusObservables</code>.</p>

<h1 id="dealing-with-leadership-changes">Dealing with leadership changes</h1>

<p>In the short term, we want to keep our current approach. That means that only the current leader Marathon instance
actively processes requests at any time. All other Marathon instances forward requests to the instance.</p>

<p>When all our state is kept in actors, we can use a simple strategy for dealing with leadership changes.
When a Marathon instance gains leadership, it will start all its top-level actors.
When a Marathon instance loses leadership, it will stop
all its top-level actors and thus lose all its non-persisted state. Since there is value in providing <code>ActorRef</code>s which
survive leadership changes, every top-level actor has a proxy which handles the appropriate starts and stops. The
corresponding code is in the <code>mesosphere.marathon.core.leadership</code> package.</p>

<h1 id="second-step-move-taskstate-into-actors">Second Step: Move TaskState into Actors</h1>

<p>Our information about tasks changes frequently. Thus, it profits most from serving reads from main memory. It is
also most prone to concurrency bugs.</p>

<p>What is more, in the <code>LaunchQueue</code> design we have to specify how many additional tasks to launch. Since the task
 launcher already has to know about all tasks of an app to satisfy constraints, it make sense to instead
 specify an absolute target number of tasks.</p>

<h1 id="conventions">Conventions</h1>

<p>These conventions guide the refactoring of the code. All code in the <code>core</code> package should follow these convetions.</p>

<h2 id="actors-as-an-implementation-detail">Actors as an implementation detail</h2>

<p>We think that Akka Actors are the most idiomatic way of dealing with shared mutable state in Scala. Unfortunately,
we do not like untyped actor references. Since typed alternatives to <code>ActorRef</code>s are not mature yet,
we restrict interactions with
and between actors to single packages. The functionality of these actors should then be exposed by trait methods,
that also make the intended interaction clear. So we use</p>

<ul>
<li>methods returning <code>Unit</code> for fire-and-forget interactions</li>
<li>methods returning <code>scala.concurrent.Future</code>s for request/response interactions</li>
<li>methods returning <code>rx.lang.scala.Observable</code>s for subscriptions to messages streams</li>
</ul>

<p>This results in more glue code between the modules but expresses the intended interaction patterns clearly.</p>

<h2 id="restrict-visibility">Restrict visibility</h2>

<p>To ensure modularity, we use the Scala <code>private</code> keyword to restrict visibility as much as possible.</p>

<h2 id="hide-implementations-in-impl-packages">Hide implementations in <code>impl</code> packages</h2>

<p>To separate the public interface of a package, we provide interface traits at the top-level of a package and
hide implementations of these interfaces in a sub <code>impl</code> package.</p>

<h2 id="dependency-injection">Dependency injection</h2>

<p>We do like separating wiring code from the rest.
At the same time, we want to get compile time errors for missing or incorrect dependencies.
This is why we perform the wiring in classes called <code>*Module</code> which simply consist of Scala code.
Right now, Marathon still contains cyclic dependencies. We do not encourage that and want to get rid of them
eventually.</p>

    </div>
</div>

          <footer>
            <p class="text-muted">
              &copy; 2016 <a class="text-muted" href="http://mesosphere.com">Mesosphere, Inc.</a>
            </p>
          </footer>
        </div>
      </div>
    </div>
    <script src="//cdn.jsdelivr.net/jquery/2.1.1/jquery.min.js"></script>
    <script src="//cdn.jsdelivr.net/bootstrap/3.2.0/js/bootstrap.min.js"></script>
  </body>
</html>
